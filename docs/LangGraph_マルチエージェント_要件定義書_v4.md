# 農業AIエージェント 総合要件定義書 v4.1

**バージョン:** 4.1  
**作成日:** 2025-07-30  
**対象:** LangGraphによる次世代マルチエージェントシステムの新規構築  
**基盤:** 既存システム「Agri_AI3」の資産と知見  
**変更点:** ハイブリッド検索の概念導入、技術スタックとデータベーススキーマの具体化。

## 第1部: プロジェクトビジョンと戦略 (Why)

### 1.1. 核心コンセプト：LINEで完結する、農家のためのAIパートナー

本プロジェクトは、日常的に使われるLINEプラットフォームをインターフェースとし、農業従事者に**「パーソナライズされ、共に進化するデジタルパートナー」**を提供することを目的とする。

キーワード検索の正確性とベクトル検索の文脈理解力を融合したハイブリッド検索により、曖昧な質問や専門用語、過去の作業に関する記憶にも的確に応答。

LINEでの自然な対話と、直感的なLIFFアプリケーションをシームレスに連携させることで、情報の分断や判断の迷いといった農業現場の根本課題を解決し、思考のプロセスそのものをなくす。誰もが熟練者のように自信を持って日々の作業に取り組める未来を実現する。

### 1.2. 解決したい課題

- **情報の散在**: 天気、市況、作業履歴などの情報が別々のツールに散在し、統合的な判断が難しい。
- **経験と勘への依存**: 新規就農者や経験の浅い作業者にとって、「どの畑に」「いつ、どの農薬を散布すべきか」といった判断は大きな負担となっている。
- **記録と報告の負荷**: 圃場での作業後、事務所に戻ってから日報を作成するなど、記録・報告作業が非効率。
- **労働力不足と多忙**: 日々の作業記録や計画立案に多くの時間が割かれている。

### 1.3. 開発のゴールと成功指標

**定性ゴール**: 農業従事者が、圃場のどこにいても、LINEを開けば「次に何をすべきか」が分かり、思考の負荷なく、自信を持って作業に集中できる状態を実現する。

**定量ゴール (KPI)**:
- 農作業の判断と思考にかかる時間を平均10分から0分にする。
- 新人作業員が判断に迷う時間が週平均60分から5分未満に短縮される。
- LINE経由での作業記録・タスク完了率が95%以上を維持する。
- AIの応答時間を平均3秒以内に短縮する。

## 第2部: システム設計とアーキテクチャ (How)

### 2.1. 全体アーキテクチャ：LINE中心のSupervisor-Workerパターン

LangGraphフレームワークを利用した**「スーパーバイザー・ワーカー」マルチエージェント・アーキテクチャ**を採用する。ユーザーとのすべての対話はLINEを起点とし、SupervisorAgentが司令塔として機能する。

```mermaid
graph TD
    subgraph "ユーザーインターフェース"
        A[👤 農業従事者] --> B[📱 LINE (チャット / LIFF)]
    end

    subgraph "AIエージェント層 (LangGraph on Google Cloud Run)"
        B -- Webhook --> C[🧠 SupervisorAgent]
        C -- "タスク割当" --> D[📖 ReadAgent]
        C -- "タスク割当" --> E[✏️ WriteAgent]
    end

    subgraph "データベース層 (MongoDB Atlas)"
        D -- "ハイブリッド検索" --> F[Atlas Search & Vector Search]
        E -- "データ書き込み" --> G[Collections]
    end
```

### 2.2. UI/UX設計：LINEとLIFFのシームレスな連携

**LINEチャット (対話インターフェース)**:
- 「今日の消毒作業、A畑とB畑で終わりました」といった自然言語での作業報告。
- 「明日の天気は？」「A畑の次の作業は？」といった簡単な質問応答。
- AIからの能動的なアラート通知（例：「明日は雨予報です。今日の内に散布を終えましょう」）。

**LIFF (LINE Front-end Framework) (リッチUI)**:
- **基本ダッシュボード**: AIによる注意喚起がある圃場のハイライト表示、本日の推奨作業リスト、気象・市況ウィジェット。
- **作業計画・可視化**: カレンダー形式での作業計画表示や、過去の作業履歴のグラフ表示。
- **複雑なデータ入力**: 新しい圃場の登録など、定型的なデータ入力フォーム。

### 2.3. エージェントと状態管理

#### エージェント詳細

**SupervisorAgent (指揮者)**: LINE Webhookからのメッセージを起点に、ユーザー意図を分析し、最適な専門エージェントを選択。最終応答を整形しLINEに返信する。

**ReadAgent (情報検索・分析専門)**: ユーザーからの問い合わせに対し、MongoDB Atlasのハイブリッド検索を駆使して最適な情報を引き出すエージェント。単なるデータ取得だけでなく、文脈を理解した高度な検索を実行する。

**ハイブリッド検索の役割**:
- **キーワード検索が有効なケース**: 特定の固有名詞や品番を正確に検索する。（例：「農薬スミチオンの散布履歴」「品種りんか409の去年の収穫量」）
- **ベクトル検索が有効なケース**: 曖昧な表現や意図を汲み取り、関連性の高い情報を提示する。（例：「葉っぱが黄色くて斑点が出てるんだけど、対策どうすればいい？」「去年の今頃、台風の前にやった作業って何だっけ？」）

**WriteAgent (書き込み専門)**: 作業記録の登録、タスクの作成・更新など、データの整合性を保証しながら書き込み処理を実行。ユーザー確認フローを内包する。

#### 状態管理 (AgriAgentState)

会話の文脈とタスクの状態を管理する。MongoDBSaverにより永続化され、ユーザーごとの会話セッションを維持する。

```python
from typing import TypedDict, Annotated, List, Dict, Any
from langchain_core.messages import BaseMessage
import operator

class AgriAgentState(TypedDict):
    messages: Annotated[List[BaseMessage], operator.add]
    user_id: str
    thread_id: str
    next_agent: str
    pending_confirmation: Dict[str, Any]
    # ... (その他、タスク管理やデバッグ用のフィールド)
```

## 第3部: データベース設計 (How)

### 3.1. 設計思想

MongoDBのドキュメントモデルを最大限に活用し、**「固定されたコア情報」と「農家ごとに自由に拡張できるカスタム情報」**を両立させる。これにより、システムの安定性と各農家の現場ニーズへの柔軟な対応を可能にする。

### 3.2. コレクション構成

| コレクション名 | 説明 |
|---------------|------|
| farms | 農業法人や農場全体の基本情報を管理。 |
| users | LINEアカウントと連携する作業者を管理。 |
| fields | 各圃場の詳細情報。カスタムプロパティによる拡張性の中心。 |
| work_records | 日々の作業記録。作業内容によって記録項目が動的に変わる。 |

### 3.3. スキーマ定義

**farms コレクション**
```json
{
  "_id": "ObjectId('...')",
  "farm_name": "ひらとり農園",
  "owner_id": "ObjectId('...')" // usersコレクションのID
}
```

**users コレクション**
```json
{
  "_id": "ObjectId('...')",
  "line_user_id": "U1234567890abcdef1234567890abcdef", // LINEのユーザーID (ユニークインデックス)
  "display_name": "とまと太郎",
  "role": "作業責任者",
  "linked_farm_id": "ObjectId('...')" // farmsコレクションのID
}
```

**fields コレクション (拡張性の中心)**
```json
{
  "_id": "ObjectId('...')",
  "farm_id": "ObjectId('...')",
  "field_name": "A-1圃場 (ハウス)",
  "current_crop": { "name": "夏秋トマト", "variety": "りんか409" },
  "embedding": [0.12, -0.45, ..., 0.98], // field_nameやcurrent_cropなどから生成したベクトル
  "custom_properties": { // ★★★ 柔軟な拡張領域 ★★★
    "土壌種類": "黒ボク土",
    "前作": "ほうれん草",
    "灌水システム": "点滴チューブ"
  }
}
```

**work_records コレクション (柔軟性の中心)**
```json
{
  "_id": "ObjectId('...')",
  "field_id": "ObjectId('...')",
  "user_id": "ObjectId('...')",
  "work_date": "ISODate('...')",
  "work_type": "農薬散布",
  "notes": "葉の裏を中心に散布。特に異常なし。",
  "embedding": [-0.78, 0.23, ..., 0.11], // notesやdetailsの内容をベクトル化
  "details": { // ★★★ 作業種類によって内容が変わる柔軟な領域 ★★★
    "pesticide_name": "アファーム乳剤",
    "dilution_ratio": "2000倍"
  }
}
```

## 第4部: 開発ロードマップと技術スタック (What)

### 4.1. 開発フェーズ戦略

| フェーズ | 期間 | 主要目標 |
|---------|------|----------|
| Phase 1: 基盤構築 | 3週間 | Supervisor+ReadAgentによるハイブリッド検索を実装し、LINEでの基本的な質疑応答を実現。 |
| Phase 2: コア機能実装 | 3週間 | WriteAgentによるLINEからの作業記録登録と確認フローを実装。LIFF基本ダッシュボードを公開。 |
| Phase 3: AI機能高度化 | 4週間 | RecommendationAgentによる作業提案機能を実装。LIFFの高機能化。 |
| Phase 4: 自律システムの実現 | 4週間 | NotificationAgentによるプロアクティブな通知機能を実装。非同期処理基盤を構築。 |

### 4.2. 技術スタック

- **UI/UX**: LINE Messaging API, LIFF
- **AI/エージェント**: Python 3.9+, LangChain, LangGraph
- **LLM / Embedding**: Google Gemini 2.5Flash, テキスト埋め込みモデル
- **データベース**: MongoDB Atlas
  - **Atlas Search**: キーワード検索とベクトル検索を統合するハイブリッド検索機能。
  - **Atlas Vector Search**: 意味に基づいたセマンティック検索の中核。
  - **非同期アクセス**: Motorライブラリを使用。
- **インフラ**: Google Cloud Functions (Webhook), Google Cloud Run (エージェント実行), Google Cloud Pub/Sub (非同期通知)
- **監視**: LangSmith